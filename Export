// ==========================================
// 8. ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ç”¨ (EXPORT TO SHEET - æœ€çµ‚å®Œå…¨ç‰ˆ)
// ==========================================

/**
 * Phase 3: ãƒ¬ãƒãƒ¼ãƒˆç”¨å–å¼•ã‚’ã€Œå•†å“æ˜ç´°å˜ä½ã€ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å‡ºåŠ›ã™ã‚‹é–¢æ•°
 * â€» è¦ªå–å¼•åãƒ»è¦ªè¨ˆä¸Šæ—¥ã‚’å…ˆé ­ã«é…ç½®
 * â€» ä¼šç¤¾åæŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ã‚’ã€ŒYYYYå¹´ã€ã‚’åŸºæº–ã«åˆ†å‰²ã™ã‚‹ã‚ˆã†ã«å¼·åŒ–
 * â€» å¯¾è±¡å¹´æœˆ(YYYY-MM)ã®æ˜‡é †ã§ã‚½ãƒ¼ãƒˆ
 */
function exportReportDealsToSheet() {
  const EXPORT_SHEET_NAME = 'raw_report_data';
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(EXPORT_SHEET_NAME);

  if (!sheet) {
    sheet = ss.insertSheet(EXPORT_SHEET_NAME);
  }

  Logger.log("ğŸ“¤ ãƒ¬ãƒãƒ¼ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã®æ˜ç´°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¾ã™...");

  // 1. ãƒ¬ãƒãƒ¼ãƒˆç”¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å…¨Deal IDã‚’å–å¾—
  const allDealsIndex = fetchAllReportDealIds();
  Logger.log(`ğŸ” å–å¼•ä»¶æ•°: ${allDealsIndex.length}ä»¶`);

  if (allDealsIndex.length === 0) {
    Logger.log("ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚çµ‚äº†ã—ã¾ã™ã€‚");
    return;
  }

  const dealIds = allDealsIndex.map(d => d.id);

  // 2. Dealã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¸€æ‹¬å–å¾—
  const dealsMap = batchFetchDealsProperties(dealIds);

  // 3. è¦ªå–å¼•(Origin Deal)ã®åå‰ã¨è¨ˆä¸Šæ—¥ã‚’ä¸€æ‹¬å–å¾—
  let parentIds = [];
  dealIds.forEach(id => {
    const d = dealsMap.get(id);
    if (d && d.origin_deal_id) {
      parentIds.push(d.origin_deal_id);
    }
  });
  parentIds = [...new Set(parentIds)];
  const parentDealsMap = batchFetchDealsProperties(parentIds); 
  Logger.log(`ğŸ‘ª è¦ªå–å¼•æ•°: ${parentIds.length}ä»¶ã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ`);

  // 4. Dealã¨Line Itemã®ç´ä»˜ã‘(Association)ã‚’ä¸€æ‹¬å–å¾—
  const associationsMap = batchFetchDealAssociations(dealIds);

  // 5. Line Itemã®è©³ç´°ã‚’ä¸€æ‹¬å–å¾—
  let allLineItemIds = [];
  associationsMap.forEach(ids => {
    allLineItemIds = allLineItemIds.concat(ids);
  });
  allLineItemIds = [...new Set(allLineItemIds)];
  const lineItemsMap = batchFetchLineItemDetails(allLineItemIds);

  Logger.log(`ğŸ“¦ å•†å“é …ç›®æ•°: ${allLineItemIds.length}ä»¶ã‚’å–å¾—ã—ã¾ã—ãŸ`);

  // 6. æ›¸ãè¾¼ã¿ç”¨é…åˆ—ã®ä½œæˆ
  const headerRow = [
    "Deal ID", "è¦ªå–å¼•å", "è¦ªå–å¼•è¨ˆä¸Šæ—¥", "å–å¼•å", "ä¼šç¤¾å", "å¯¾è±¡å¹´æœˆ", "ã‚¹ãƒ†ãƒ¼ã‚¸", "æ‹…å½“è€…ID", "å¥‘ç´„ç¢ºåº¦",
    "å•†å“å", "å˜ä¾¡", "æ•°é‡", "é‡‘é¡(LineItem)"
  ];
  
  // ãƒ‡ãƒ¼ã‚¿è¡Œæ ¼ç´ç”¨
  const dataRows = [];

  dealIds.forEach(dealId => {
    const dealProps = dealsMap.get(dealId);
    if (!dealProps) return;

    const dealName = dealProps.dealname || "";
    
    // è¦ªå–å¼•æƒ…å ±ã®å–å¾—
    const originId = dealProps.origin_deal_id;
    let parentDealName = "";
    let parentFirstRecordedDate = "";

    if (originId) {
      const parentDeal = parentDealsMap.get(originId);
      if (parentDeal) {
        parentDealName = parentDeal.dealname;
        parentFirstRecordedDate = parentDeal.first_recorded_date || "";
      } else {
        parentDealName = "(å‰Šé™¤æ¸ˆ/å–å¾—ä¸å¯)";
      }
    }

    // â˜…ä¿®æ­£ç®‡æ‰€: ä¼šç¤¾åãƒ»å¹´æœˆæŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ (æ­£è¦è¡¨ç¾ç‰ˆ)
    // ã€Œã‚¹ãƒšãƒ¼ã‚¹ + æ•°å­—4æ¡ + å¹´ã€ã‚’æ¢ã™ (ä¾‹: " 2025å¹´")
    let companyName = dealName;
    let targetMonth = "";
    
    // æ­£è¦è¡¨ç¾: åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ + 20xxå¹´
    const datePatternIndex = dealName.search(/\s20\d{2}å¹´/);

    if (datePatternIndex !== -1) {
      // è¦‹ã¤ã‹ã£ãŸå ´æ‰€ã‚ˆã‚Šå‰ = ä¼šç¤¾å
      companyName = dealName.substring(0, datePatternIndex);
      // è¦‹ã¤ã‹ã£ãŸå ´æ‰€ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤ã„ã¦å¾Œã‚ = å¹´æœˆ
      targetMonth = dealName.substring(datePatternIndex + 1);
    } else {
      // ä¸‡ãŒä¸€ãƒãƒƒãƒã—ãªã„å ´åˆï¼ˆéå»ãƒ‡ãƒ¼ã‚¿ãªã©ï¼‰ã¯å¾“æ¥ã®æœ€å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹åˆ†å‰²ã‚’è©¦ã¿ã‚‹
      const lastSpace = dealName.lastIndexOf(" ");
      if (lastSpace !== -1) {
        companyName = dealName.substring(0, lastSpace);
        targetMonth = dealName.substring(lastSpace + 1);
      }
    }

    // first_recorded_date ãŒã‚ã‚Œã°å„ªå…ˆã—ã¦å¹´æœˆã‚’ä¸Šæ›¸ã
    if (dealProps.first_recorded_date) {
      const d = new Date(dealProps.first_recorded_date);
      const yyyy = d.getFullYear();
      const mm = ("0" + (d.getMonth() + 1)).slice(-2);
      targetMonth = `${yyyy}-${mm}`;
    }

    const commonData = [
      dealId,
      parentDealName,          // è¦ªå–å¼•å
      parentFirstRecordedDate, // è¦ªå–å¼•è¨ˆä¸Šæ—¥
      dealName,                // å–å¼•å
      companyName,             // â˜…æ­£è¦è¡¨ç¾ã§æŠ½å‡ºã•ã‚ŒãŸä¼šç¤¾å
      targetMonth,
      dealProps.dealstage,
      dealProps.hubspot_owner_id,
      dealProps.contract_certainty
    ];

    const linkedLineItemIds = associationsMap.get(dealId) || [];

    if (linkedLineItemIds.length > 0) {
      linkedLineItemIds.forEach(liId => {
        const item = lineItemsMap.get(liId);
        if (item) {
          dataRows.push([
            ...commonData,
            item.name,
            Number(item.price || 0),
            Number(item.quantity || 0),
            Number(item.amount || 0)
          ]);
        } else {
          dataRows.push([...commonData, "(è©³ç´°å–å¾—å¤±æ•—)", 0, 0, 0]);
        }
      });
    } else {
      dataRows.push([...commonData, "(å•†å“ãªã—)", 0, 0, 0]);
    }
  });

  // â˜…ä¸¦ã³æ›¿ãˆå®Ÿè¡Œ (å¯¾è±¡å¹´æœˆ: Index 5 ã®æ˜‡é †)
  dataRows.sort((a, b) => {
    // 1. å¯¾è±¡å¹´æœˆã§æ¯”è¼ƒ
    if (a[5] < b[5]) return -1;
    if (a[5] > b[5]) return 1;
    
    // 2. å¹´æœˆãŒåŒã˜ãªã‚‰ä¼šç¤¾å(Index 4)ã§æ¯”è¼ƒ
    if (a[4] < b[4]) return -1;
    if (a[4] > b[4]) return 1;

    return 0;
  });

  const finalRows = [headerRow, ...dataRows];

  // 7. ã‚·ãƒ¼ãƒˆã¸æ›¸ãè¾¼ã¿
  sheet.clear();
  if (finalRows.length > 0) {
    sheet.getRange(1, 1, finalRows.length, finalRows[0].length).setValues(finalRows);
    sheet.getRange(1, 1, 1, finalRows[0].length).setFontWeight("bold").setBackground("#f3f3f3");
    sheet.setFrozenRows(1);
  }

  Logger.log("âœ… æ˜ç´°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†: raw_report_data ã‚’æ›´æ–°ã—ã¾ã—ãŸ(å¹´å·åŒºåˆ‡ã‚Šç‰ˆ)ã€‚");
}

// ----------------------------------------------------
// ä»¥ä¸‹ã€å¿…é ˆã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ (çœç•¥ãªã—ãƒ»å¤‰æ›´ãªã—)
// ----------------------------------------------------

function fetchAllReportDealIds() {
  const url = `https://api.hubapi.com/crm/v3/objects/deals/search`;
  let allResults = [];
  let after = 0;
  let hasMore = true;

  while (hasMore) {
    const payload = {
      filterGroups: [{ filters: [{ propertyName: "pipeline", operator: "EQ", value: REPORT_PIPELINE_ID }] }],
      properties: [], 
      limit: 100,
      after: after
    };
    const res = _fetchHubSpot("POST", url, payload);
    allResults = allResults.concat(res.results || []);
    if (res.paging && res.paging.next) {
      after = res.paging.next.after;
    } else {
      hasMore = false;
    }
    Utilities.sleep(50);
  }
  return allResults;
}

function batchFetchDealsProperties(dealIds) {
  if (dealIds.length === 0) return new Map();

  const map = new Map();
  const chunks = chunkArray(dealIds, 100);

  chunks.forEach(chunk => {
    const url = `https://api.hubapi.com/crm/v3/objects/deals/batch/read`;
    const payload = {
      properties: ["dealname", "dealstage", "hubspot_owner_id", "contract_certainty", "first_recorded_date", "origin_deal_id"],
      inputs: chunk.map(id => ({ id: id }))
    };
    try {
      const res = _fetchHubSpot("POST", url, payload);
      (res.results || []).forEach(d => {
        map.set(d.id, d.properties);
      });
    } catch (e) {
      Logger.log(`Batch Fetch Deals Prop Error: ${e.message}`);
    }
    Utilities.sleep(100);
  });
  return map;
}

function batchFetchDealAssociations(dealIds) {
  const map = new Map();
  const chunks = chunkArray(dealIds, 100);
  const FROM_OBJECT = "deals";
  const TO_OBJECT = "line_items";

  chunks.forEach(chunk => {
    const url = `https://api.hubapi.com/crm/v3/associations/${FROM_OBJECT}/${TO_OBJECT}/batch/read`;
    const payload = {
      inputs: chunk.map(id => ({ id: id }))
    };

    try {
      const res = _fetchHubSpot("POST", url, payload);
      (res.results || []).forEach(r => {
        const fromId = r.from.id;
        const toIds = (r.to || []).map(t => t.id);
        map.set(fromId, toIds);
      });
    } catch (e) {
      Logger.log(`Batch Fetch Associations Error: ${e.message}`);
    }
    Utilities.sleep(100);
  });
  return map;
}

function batchFetchLineItemDetails(lineItemIds) {
  const map = new Map();
  if (lineItemIds.length === 0) return map;

  const chunks = chunkArray(lineItemIds, 100);

  chunks.forEach(chunk => {
    const url = `https://api.hubapi.com/crm/v3/objects/line_items/batch/read`;
    const payload = {
      properties: ["name", "price", "quantity", "amount", "hs_recurring_billing_period", "hs_recurring_billing_start_date"],
      inputs: chunk.map(id => ({ id: id }))
    };

    try {
      const res = _fetchHubSpot("POST", url, payload);
      (res.results || []).forEach(item => {
        map.set(item.id, {
          id: item.id,
          name: item.properties.name,
          price: item.properties.price,
          quantity: item.properties.quantity,
          amount: item.properties.amount,
          period: item.properties.hs_recurring_billing_period,
          start_date: item.properties.hs_recurring_billing_start_date
        });
      });
    } catch (e) {
      Logger.log(`Batch Fetch LineItems Error: ${e.message}`);
    }
    Utilities.sleep(100);
  });
  return map;
}

function chunkArray(array, size) {
  const results = [];
  for (let i = 0; i < array.length; i += size) {
    results.push(array.slice(i, i + size));
  }
  return results;
}

/**
 * ã€ãƒ†ã‚¹ãƒˆç”¨ã€‘æ˜ç´°å½¢å¼ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆ10ä»¶é™å®šãƒ»è¦ªæƒ…å ±å…ˆé ­ç‰ˆï¼‰
 * â€» å†…éƒ¨ã§æœ¬ç•ªç”¨ã® batchFetch... ç³»ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½¿ç”¨ã—ã¾ã™
 */
function test_exportReportDeals_Detail_Limit10() {
  const EXPORT_SHEET_NAME = 'raw_report_data';
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(EXPORT_SHEET_NAME);

  if (!sheet) {
    sheet = ss.insertSheet(EXPORT_SHEET_NAME);
  }

  Logger.log("ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: æœ€æ–°10ä»¶ï¼ˆè¦ªæƒ…å ±å…ˆé ­ï¼‰ã‚’å–å¾—ã—ã¾ã™...");

  // 1. æœ€æ–°ã®Deal IDã‚’10ä»¶ã ã‘å–å¾—
  const url = `https://api.hubapi.com/crm/v3/objects/deals/search`;
  const payload = {
    filterGroups: [{ filters: [{ propertyName: "pipeline", operator: "EQ", value: REPORT_PIPELINE_ID }] }],
    properties: [], 
    limit: 10,      // â˜…10ä»¶ã«åˆ¶é™
    sorts: [
      { propertyName: "hs_lastmodifieddate", direction: "DESCENDING" } // æœ€æ–°é †
    ]
  };

  const res = _fetchHubSpot("POST", url, payload);
  const dealIds = (res.results || []).map(d => d.id);
  
  Logger.log(`ğŸ” å–å¾—å¯¾è±¡ID: ${dealIds.length}ä»¶`);

  if (dealIds.length === 0) {
    Logger.log("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  // 2. Dealã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¸€æ‹¬å–å¾— (origin_deal_id ã‚‚å–å¾—)
  const dealsMap = batchFetchDealsProperties(dealIds);

  // 3. è¦ªå–å¼•(Origin Deal)ã®åå‰ã¨è¨ˆä¸Šæ—¥ã‚’ä¸€æ‹¬å–å¾—
  let parentIds = [];
  dealIds.forEach(id => {
    const d = dealsMap.get(id);
    if (d && d.origin_deal_id) {
      parentIds.push(d.origin_deal_id);
    }
  });
  parentIds = [...new Set(parentIds)];
  const parentDealsMap = batchFetchDealsProperties(parentIds); 

  // 4. Dealã¨Line Itemã®ç´ä»˜ã‘(Association)ã‚’ä¸€æ‹¬å–å¾—
  const associationsMap = batchFetchDealAssociations(dealIds);

  // 5. Line Itemã®è©³ç´°ã‚’ä¸€æ‹¬å–å¾—
  let allLineItemIds = [];
  associationsMap.forEach(ids => {
    allLineItemIds = allLineItemIds.concat(ids);
  });
  allLineItemIds = [...new Set(allLineItemIds)];
  const lineItemsMap = batchFetchLineItemDetails(allLineItemIds);

  Logger.log(`ğŸ“¦ å•†å“é …ç›®æ•°: ${allLineItemIds.length}ä»¶`);

  // 6. æ›¸ãè¾¼ã¿ç”¨é…åˆ—ã®ä½œæˆ
  // â˜…ä¸¦ã³é †ã‚’å¤‰æ›´: è¦ªå–å¼•åã€è¦ªè¨ˆä¸Šæ—¥ã‚’å·¦å´ã«é…ç½®
  const rows = [
    [
      "Deal ID", "è¦ªå–å¼•å", "è¦ªå–å¼•è¨ˆä¸Šæ—¥", "å–å¼•å", "ä¼šç¤¾å", "å¯¾è±¡å¹´æœˆ", "ã‚¹ãƒ†ãƒ¼ã‚¸", "æ‹…å½“è€…ID", "å¥‘ç´„ç¢ºåº¦", "è¨ˆä¸Šæ—¥(æœˆæ¬¡)",
      "å•†å“å", "å˜ä¾¡", "æ•°é‡", "é‡‘é¡(LineItem)", "æœŸé–“", "é–‹å§‹æ—¥"
    ]
  ];

  dealIds.forEach(dealId => {
    const dealProps = dealsMap.get(dealId);
    if (!dealProps) return;

    const dealName = dealProps.dealname || "";
    
    // è¦ªå–å¼•æƒ…å ±ã®å–å¾—
    const originId = dealProps.origin_deal_id;
    let parentDealName = "";
    let parentFirstRecordedDate = "";

    if (originId) {
      const parentDeal = parentDealsMap.get(originId);
      if (parentDeal) {
        parentDealName = parentDeal.dealname;
        parentFirstRecordedDate = parentDeal.first_recorded_date || ""; // è¦ªã®è¨ˆä¸Šæ—¥
      } else {
        parentDealName = "(å‰Šé™¤æ¸ˆ/å–å¾—ä¸å¯)";
      }
    }

    // ä¼šç¤¾åãƒ»å¹´æœˆæŠ½å‡º
    const splitName = dealName.split(" ");
    let companyName = splitName[0]; 
    let targetMonth = splitName.length > 1 ? splitName[1] : ""; 

    if (dealProps.first_recorded_date) {
      const d = new Date(dealProps.first_recorded_date);
      const yyyy = d.getFullYear();
      const mm = ("0" + (d.getMonth() + 1)).slice(-2);
      targetMonth = `${yyyy}-${mm}`;
    }

    const commonData = [
      dealId,
      parentDealName,          // è¦ªå–å¼•å
      parentFirstRecordedDate, // è¦ªå–å¼•è¨ˆä¸Šæ—¥
      dealName,                // å–å¼•å
      companyName,
      targetMonth,
      dealProps.dealstage,
      dealProps.hubspot_owner_id,
      dealProps.contract_certainty,
      dealProps.first_recorded_date
    ];

    // ç´ä»˜ã„ã¦ã„ã‚‹å•†å“IDãƒªã‚¹ãƒˆã‚’å–å¾—
    const linkedLineItemIds = associationsMap.get(dealId) || [];

    if (linkedLineItemIds.length > 0) {
      linkedLineItemIds.forEach(liId => {
        const item = lineItemsMap.get(liId);
        if (item) {
          rows.push([
            ...commonData,
            item.name,
            Number(item.price || 0),
            Number(item.quantity || 0),
            Number(item.amount || 0),
            item.period,
            item.start_date
          ]);
        } else {
          rows.push([...commonData, "(è©³ç´°å–å¾—å¤±æ•—)", 0, 0, 0, "", ""]);
        }
      });
    } else {
      rows.push([...commonData, "(å•†å“ãªã—)", 0, 0, 0, "", ""]);
    }
  });

  // 7. ã‚·ãƒ¼ãƒˆã¸æ›¸ãè¾¼ã¿
  sheet.clear();
  if (rows.length > 0) {
    sheet.getRange(1, 1, rows.length, rows[0].length).setValues(rows);
    sheet.getRange(1, 1, 1, rows[0].length).setFontWeight("bold").setBackground("#e6f7ff");
    sheet.setFrozenRows(1);
  }

  Logger.log("âœ… ãƒ†ã‚¹ãƒˆå®Œäº†: raw_report_data ã«æœ€æ–°10ä»¶ï¼ˆè¦ªæƒ…å ±ä»˜ãï¼‰ã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚");
}
