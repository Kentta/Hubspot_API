/**
 * HubSpot å–¶æ¥­Deal â†’ ãƒ¬ãƒãƒ¼ãƒˆDeal è‡ªå‹•åŒæœŸã‚·ã‚¹ãƒ†ãƒ  (v1.2 Discount Logic Fix)
 * * æ¦‚è¦:
 * 1. å–¶æ¥­ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ›´æ–°ã‚’æ¤œçŸ¥
 * 2. å¥‘ç´„æœŸé–“(P12Mç­‰)ã«åŸºã¥ã„ã¦ã€æœˆã”ã¨ã®ãƒ¬ãƒãƒ¼ãƒˆç”¨Dealã«è‡ªå‹•å±•é–‹
 * 3. å•†å“å¤‰æ›´æ™‚ã¯ã€Œå…¨å‰Šé™¤ï¼†å†ä½œæˆã€ã§æ•´åˆæ€§ã‚’æ‹…ä¿
 * 4. ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´æ™‚ã¯ã€Œãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ›´æ–°ã€ã®ã¿å®Ÿè¡Œ
 * 5. Discountï¼ˆå€¤å¼•ãï¼‰ã¯ã€Œæœˆæ•°ã§å‰²ã‚‰ãšã«ãã®ã¾ã¾ã€é©ç”¨ã™ã‚‹ã‚ˆã†ä¿®æ­£
 */

// ==========================================
// 1. è¨­å®šãƒ»å®šæ•° (CONFIG)
// ==========================================
const HUBSPOT_TOKEN = 'XXX'; 
const SALES_PIPELINE_ID = 'default';        // å–¶æ¥­ç”¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
const REPORT_PIPELINE_ID = '810580395';     // ãƒ¬ãƒãƒ¼ãƒˆç”¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ID
const SHEET_NAME = 'sync_state';            // çŠ¶æ…‹ç®¡ç†ç”¨ã‚·ãƒ¼ãƒˆå

// ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒƒãƒ”ãƒ³ã‚° (å–¶æ¥­ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¸ID : ãƒ¬ãƒãƒ¼ãƒˆç”¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ID)
const STAGE_MAP = {
  "default": {
    "appointmentscheduled": "1193683864",   // ãƒ’ã‚¢ãƒªãƒ³ã‚°
    "qualifiedtobuy": "1193683865",         // ä¸€æ¬¡ææ¡ˆ
    "presentationscheduled": "1193683866",  // äºŒæ¬¡ææ¡ˆ
    "decisionmakerboughtin": "1193683867",  // æœ€çµ‚ææ¡ˆ
    "contractsent": "1193683868",           // ä»®å—æ³¨
    "closedwon": "1193683869",              // å—æ³¨
    "1193842304": "1228201899",             // æ¡ˆä»¶æ¶ˆæ»…
    "1193842305": "1193683870",             // å¤±æ³¨
    "closedlost": "1230843265",             // ãƒªã‚µã‚¤ã‚¯ãƒ«ï¼ˆAMæˆ»ã—ï¼‰ 
    "1214496305": "1230843266",             // AMãƒŠãƒ¼ãƒãƒ£ãƒªãƒ³ã‚° 
    "2413958": "1230843267",             // ãƒªã‚µã‚¤ã‚¯ãƒ«ï¼ˆBDRæˆ»ã—ï¼‰
  }
};


// ==========================================
// 2. ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•° (MAIN TRIGGER)
// ==========================================
function main_syncDeals() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (!sheet) {
    Logger.log(`âŒ ã‚·ãƒ¼ãƒˆ '${SHEET_NAME}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä½œæˆã—ã¦ãã ã•ã„ã€‚`);
    return;
  }

  // 1. ç›´è¿‘24æ™‚é–“ä»¥å†…ã«æ›´æ–°ã•ã‚ŒãŸå–¶æ¥­Dealã‚’å–å¾—
  const updatedDeals = api_fetchRecentlyUpdatedDeals(240);
  if (updatedDeals.length === 0) {
    Logger.log("â³ æ›´æ–°ã•ã‚ŒãŸå–¶æ¥­Dealã¯ã‚ã‚Šã¾ã›ã‚“ã€‚çµ‚äº†ã—ã¾ã™ã€‚");
    return;
  }

  // 2. ã‚·ãƒ¼ãƒˆã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã‚€
  const lastRow = sheet.getLastRow();
  // èª­ã¿è¾¼ã¿ç¯„å›²ã‚’11åˆ—(Kåˆ—)ã¾ã§æ‹¡å¼µ
  const sheetData = lastRow > 1 ? sheet.getRange(2, 1, lastRow - 1, 11).getValues() : [];
  
  const stateMap = new Map();
  sheetData.forEach((row, index) => {
    stateMap.set(String(row[0]), { rowIndex: index + 2, rowData: row });
  });

  Logger.log(`ğŸ” å¯¾è±¡Dealæ•°: ${updatedDeals.length}ä»¶`);

  // 3. å„Dealã«ã¤ã„ã¦åŒæœŸå‡¦ç†
  updatedDeals.forEach(deal => {
    try {
      processSingleDeal(deal, sheet, stateMap);
    } catch (e) {
      Logger.log(`âŒ ã‚¨ãƒ©ãƒ¼ (Deal: ${deal.properties.dealname}): ${e.message}`);
    }
  });
}

/**
 * å€‹åˆ¥ã®Dealã«å¯¾ã™ã‚‹å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
 */
function processSingleDeal(deal, sheet, stateMap) {
  const dealId = deal.id;
  const props = deal.properties;
  
  // ç¾åœ¨ã®å•†å“çŠ¶æ…‹ã‚’å–å¾—
  const currentLineItemIds = api_fetchLineItemIdsForDeal(dealId);
  const currentSnapshot = {};
  
  currentLineItemIds.forEach(id => {
    const detail = api_fetchLineItemDetail(id);
    if(detail && detail.properties) {
      currentSnapshot[id] = {
        name: detail.properties.name,
        price: detail.properties.price,
        quantity: detail.properties.quantity,
        period: detail.properties.hs_recurring_billing_period,
        start: detail.properties.hs_recurring_billing_start_date,
        discount: detail.properties.discount || "0" 
      };
    }
  });
  
  const currentSnapshotJson = JSON.stringify(currentSnapshot);
  const lineItemIdsStr = "'" + currentLineItemIds.join(",");

  const state = stateMap.get(dealId);
  let actionLog = "";

  if (!state) {
    // --- æ–°è¦æ¤œçŸ¥ ---
    actionLog = "æ–°è¦ä½œæˆ";
    logic_rebuildReportDeals(dealId, props, currentSnapshot);

    sheet.appendRow([
      dealId, props.dealname, props.dealstage, props.pipeline, 
      props.contract_expected_date, props.contract_certainty,
      lineItemIdsStr, currentSnapshotJson,
      props.hs_lastmodifieddate, new Date().toISOString(),
      props.hubspot_owner_id || ""
    ]);

  } else {
    // --- æ—¢å­˜æ›´æ–° ---
    const lastSnapshotJson = state.rowData[7] || "{}";
    const lastName = state.rowData[1];
    const lastStage = state.rowData[2];
    const rawLastDate = state.rowData[4]; 
    const lastCertainty = state.rowData[5];
    const lastOwnerId = state.rowData[10];

    // æ—¥ä»˜æ­£è¦åŒ–
    const normalizeDate = (d) => {
      if (!d) return "";
      if (d instanceof Date) {
        return Utilities.formatDate(d, Session.getScriptTimeZone(), "yyyy-MM-dd");
      }
      return String(d);
    };

    const lastDateStr = normalizeDate(rawLastDate);
    const newDateStr = props.contract_expected_date || "";

    // åˆ¤å®š
    const isRebuildRequired = (
      currentSnapshotJson !== lastSnapshotJson || 
      String(lastName || "") !== String(props.dealname || "")
    );

    const isStageDiff = String(lastStage || "") !== String(props.dealstage || "");
    const isDateDiff = lastDateStr !== newDateStr;
    const isCertaintyDiff = String(lastCertainty || "") !== String(props.contract_certainty || "");
    const isOwnerDiff = String(lastOwnerId || "") !== String(props.hubspot_owner_id || "");

    const isPropUpdateRequired = (isStageDiff || isDateDiff || isCertaintyDiff || isOwnerDiff);

    if (isRebuildRequired) {
      actionLog = "é‡è¦å¤‰æ›´(å•†å“oråå‰) -> å…¨å†æ§‹ç¯‰";
      logic_rebuildReportDeals(dealId, props, currentSnapshot);
    } else if (isPropUpdateRequired) {
      const reasons = [];
      if(isStageDiff) reasons.push(`Stage[${lastStage}â†’${props.dealstage}]`);
      if(isDateDiff) reasons.push(`Date[${lastDateStr}â†’${newDateStr}]`);
      if(isCertaintyDiff) reasons.push(`Certainty[${lastCertainty}â†’${props.contract_certainty}]`);
      if(isOwnerDiff) reasons.push(`Owner[${lastOwnerId}â†’${props.hubspot_owner_id}]`);
      
      actionLog = `ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å¤‰æ›´(${reasons.join(", ")}) -> æ›´æ–°ã®ã¿`;
      logic_updateReportProperties(dealId, props);
    } else {
      actionLog = "å¤‰æ›´ãªã— -> ã‚¹ã‚­ãƒƒãƒ—";
    }

    if (actionLog.includes("å†æ§‹ç¯‰") || actionLog.includes("æ›´æ–°ã®ã¿")) {
       const newRow = [
        dealId, props.dealname, props.dealstage, props.pipeline, 
        props.contract_expected_date, props.contract_certainty,
        lineItemIdsStr,
        currentSnapshotJson,
        props.hs_lastmodifieddate, new Date().toISOString(),
        props.hubspot_owner_id || ""
      ];
      sheet.getRange(state.rowIndex, 1, 1, 11).setValues([newRow]);
    }
  }

  Logger.log(`[${props.dealname}] ${actionLog}`);
}


// ==========================================
// 3. ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•° (CORE LOGIC)
// ==========================================

/**
 * ãƒ­ã‚¸ãƒƒã‚¯A: å†æ§‹ç¯‰
 */
function logic_rebuildReportDeals(originDealId, salesProps, snapshot) {
  const existingDeals = api_searchExistingReportDeals(originDealId);
  if (existingDeals.length > 0) {
    api_batchArchiveDeals(existingDeals.map(d => d.id));
    Utilities.sleep(1000); 
  }

  if (Object.keys(snapshot).length === 0) return;

  // ãƒ‡ãƒ¼ã‚¿ã®æœˆæ¬¡å±•é–‹
  const monthlyData = helper_expandMonthlyData(snapshot);

  const companyName = salesProps.dealname.split("_")[0];
  const reportStage = STAGE_MAP["default"][salesProps.dealstage];
  
  if (!reportStage) {
    Logger.log(`âš ï¸ ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„ã‚¹ãƒ†ãƒ¼ã‚¸ã®ãŸã‚ä½œæˆã‚¹ã‚­ãƒƒãƒ—: ${salesProps.dealstage}`);
    return;
  }

  Object.keys(monthlyData).sort().forEach(ym => {
    const m = monthlyData[ym];
    const [yyyy, mm] = ym.split("-");

    const dealPayload = {
      dealname: `${companyName} ${yyyy}å¹´${mm}æœˆåˆ†`,
      pipeline: REPORT_PIPELINE_ID,
      dealstage: reportStage,
      origin_deal_id: originDealId,
      hubspot_owner_id: salesProps.hubspot_owner_id || "",
      amount: m.amount, 
      first_recorded_date: m.first_recorded_date,
      contract_expected_date: salesProps.contract_expected_date || "",
      contract_certainty: salesProps.contract_certainty || ""
    };

    const newDealId = api_createDeal(dealPayload);

    if (newDealId) {
      m.lineItems.forEach(li => {
        api_createLineItemAndAssociate(newDealId, li);
      });
    }
    
    Utilities.sleep(500); 
  });
}

/**
 * ãƒ­ã‚¸ãƒƒã‚¯B: æ›´æ–°ã®ã¿
 */
function logic_updateReportProperties(originDealId, salesProps) {
  const existingDeals = api_searchExistingReportDeals(originDealId);
  if (existingDeals.length === 0) return;

  const reportStage = STAGE_MAP["default"][salesProps.dealstage];

  const inputs = existingDeals.map(d => {
    return {
      id: d.id,
      properties: {
        dealstage: reportStage || d.properties.dealstage,
        contract_certainty: salesProps.contract_certainty,
        contract_expected_date: salesProps.contract_expected_date,
        hubspot_owner_id: salesProps.hubspot_owner_id 
      }
    };
  });

  api_batchUpdateDeals(inputs);
}


// ==========================================
// 4. ãƒ‡ãƒ¼ã‚¿å±•é–‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ (MATH helper)
// ==========================================
/**
 * å•†å“ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å—ã‘å–ã‚Šã€æœˆã”ã¨ã«é›†è¨ˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
 * â˜…ä¿®æ­£: Discountã¯æœˆå‰²ã›ãšãã®ã¾ã¾é©ç”¨
 */
function helper_expandMonthlyData(snapshot) {
  let monthlyDeals = {}; 

  Object.values(snapshot).forEach(item => {
    let price = Number(item.price || 0);
    const qty = Number(item.quantity || 0);
    const name = item.name || "";
    
    // å€¤å¼•ã(HubSpotã®APIä»•æ§˜ä¸Šã€ã“ã‚Œã¯ã€Œå˜ä¾¡ã«å¯¾ã™ã‚‹å€¤å¼•ã€ã¾ãŸã¯ã€Œæœˆé¡å€¤å¼•ã€ã¨ã—ã¦è¿”ã£ã¦ãã¦ã„ã‚‹)
    const discountValue = Number(item.discount || 0);

    // å•†å“åã«ã‚ˆã‚‹ãƒã‚¤ãƒŠã‚¹è£œæ­£ (æ‰‹å‹•èª¿æ•´ç”¨)
    if (name.includes("ã€æ¸›é¡ã€‘") || name.includes("â–¼") || name.includes("å€¤å¼•")) {
      if (price > 0) price = price * -1;
    }

    // æœŸé–“è§£æ
    const periodStr = item.period || "P1M"; 
    const months = Number(periodStr.replace("P", "").replace("M", "")) || 1;
    
    // â˜…ä¿®æ­£ç®‡æ‰€: Discountã¯æœˆæ•°ã§å‰²ã‚‰ãªã„ (APIã®å€¤ = æœˆã”ã¨ã®å€¤å¼•ãé¡ã¨ã¿ãªã™)
    const monthlyDiscount = discountValue;
    
    // æœˆæ¬¡MRR = (å˜ä¾¡ * æ•°é‡) - æœˆæ¬¡å€¤å¼•ãé¡
    const mrr = (price * qty) - monthlyDiscount;

    const startDateStr = item.start;
    if (!startDateStr) return; 

    let startDate = new Date(startDateStr);
    let originalDay = startDate.getDate();

    for (let i = 0; i < months; i++) {
      let temp = new Date(startDate);
      temp.setDate(1); 
      temp.setMonth(temp.getMonth() + i);

      let year = temp.getFullYear();
      let month = temp.getMonth();
      let newDate = new Date(year, month, originalDay);

      if (newDate.getMonth() !== month) {
        newDate = new Date(year, month + 1, 0);
      }

      let yyyy = newDate.getFullYear();
      let mm = ("0" + (newDate.getMonth() + 1)).slice(-2);
      let dd = ("0" + newDate.getDate()).slice(-2);
      const billingDate = `${yyyy}-${mm}-${dd}`;
      const ym = `${yyyy}-${mm}`;

      if (!monthlyDeals[ym]) {
        monthlyDeals[ym] = {
          amount: 0,
          first_recorded_date: billingDate,
          lineItems: []
        };
      }

      monthlyDeals[ym].amount += mrr; // å‰²å¼•å¾Œã®é‡‘é¡ã‚’åŠ ç®—
      monthlyDeals[ym].lineItems.push({
        name: item.name,
        price: price,
        quantity: qty,
        discount: monthlyDiscount, // ãã®ã¾ã¾ã®å€¤ã‚’ã‚»ãƒƒãƒˆ
        hs_recurring_billing_period: "P1M",
        hs_recurring_billing_start_date: billingDate
      });
    }
  });

  return monthlyDeals;
}


// ==========================================
// 5. HubSpot API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (API CLIENT)
// ==========================================

function api_fetchRecentlyUpdatedDeals(hours) {
  const since = new Date(Date.now() - hours * 60 * 60 * 1000).toISOString();
  const url = `https://api.hubapi.com/crm/v3/objects/deals/search`;
  
  const payload = {
    filterGroups: [
      {
        filters: [
          { propertyName: "hs_lastmodifieddate", operator: "GTE", value: since },
          { propertyName: "pipeline", operator: "EQ", value: SALES_PIPELINE_ID }
        ]
      }
    ],
    properties: [
      "dealname", "dealstage", "pipeline", 
      "hubspot_owner_id", 
      "contract_expected_date", "contract_certainty", 
      "hs_lastmodifieddate"
    ],
    limit: 100
  };
  return _fetchHubSpot("POST", url, payload).results || [];
}

/**
 * ç‰¹å®šã®å–å¼•ã«ç´ä»˜ã„ã¦ã„ã‚‹å•†å“(Line Item)ã®IDãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹
 * â€» ç›£æŸ»ãªã©ã®å¤§é‡å‡¦ç†ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã«ãã„ã€Œè»½é‡ç‰ˆAPIã€ã‚’ä½¿ç”¨
 * â€» ã“ã®å¤‰æ›´ã¯ main_syncDeals ã«ã‚‚é©ç”¨ã•ã‚Œã€åŒæœŸã®å®‰å®šæ€§ãŒå‘ä¸Šã—ã¾ã™
 */
function api_fetchLineItemIdsForDeal(dealId) {
  // ç´ä»˜ã‘æƒ…å ±ã ã‘ã‚’å°‚é–€ã«å–å¾—ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆé€šä¿¡ãŒè»½ãç¢ºå®Ÿï¼‰
  const url = `https://api.hubapi.com/crm/v3/objects/deals/${dealId}/associations/line_items`;
  
  try {
    const data = _fetchHubSpot("GET", url);
    // data.results ãŒç©ºã€ã¾ãŸã¯å­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºé…åˆ—ã‚’è¿”ã™
    if (!data.results || data.results.length === 0) {
      return [];
    }
    return data.results.map(r => r.id);
  } catch (e) {
    // APIãƒ¬ãƒ¼ãƒˆåˆ¶é™(429)ãªã©ã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸå ´åˆã€
    // ã“ã“ã§ç©ºé…åˆ—ã‚’è¿”ã™ã¨ã€Œå•†å“ãªã—ã€ã¨èª¤åˆ¤å®šã•ã‚Œã‚‹ãŸã‚ã€
    // ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã—ã¦ã€æ„å›³çš„ã«ã€Œç©ºã€ã‚’è¿”ã™ï¼ˆã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
    Logger.log(`âš ï¸ å•†å“å–å¾—ã‚¨ãƒ©ãƒ¼ (DealID: ${dealId}): ${e.message}`);
    return []; 
  }
}

function api_fetchLineItemDetail(itemId) {
  // properties ã« discount ã‚’è¿½åŠ 
  const url = `https://api.hubapi.com/crm/v3/objects/line_items/${itemId}?properties=name,price,quantity,hs_recurring_billing_period,hs_recurring_billing_start_date,discount`;
  try {
    return _fetchHubSpot("GET", url);
  } catch(e) { return null; }
}

function api_searchExistingReportDeals(originDealId) {
  const url = `https://api.hubapi.com/crm/v3/objects/deals/search`;
  const payload = {
    filterGroups: [{ filters: [{ propertyName: "origin_deal_id", operator: "EQ", value: originDealId }] }],
    properties: ["dealname", "dealstage"],
    limit: 100
  };
  return _fetchHubSpot("POST", url, payload).results || [];
}

function api_batchArchiveDeals(ids) {
  const url = `https://api.hubapi.com/crm/v3/objects/deals/batch/archive`;
  const inputs = ids.map(id => ({ id: id }));
  return _fetchHubSpot("POST", url, { inputs });
}

function api_batchUpdateDeals(inputs) {
  const url = `https://api.hubapi.com/crm/v3/objects/deals/batch/update`;
  return _fetchHubSpot("POST", url, { inputs });
}

function api_createDeal(properties) {
  const url = `https://api.hubapi.com/crm/v3/objects/deals`;
  const data = _fetchHubSpot("POST", url, { properties });
  return data.id;
}

function api_createLineItemAndAssociate(dealId, props) {
  const url = `https://api.hubapi.com/crm/v3/objects/line_items`;
  const payload = {
    properties: props,
    associations: [
      {
        to: { id: dealId },
        types: [{ associationCategory: "HUBSPOT_DEFINED", associationTypeId: 20 }] 
      }
    ]
  };
  return _fetchHubSpot("POST", url, payload).id;
}

// å…±é€šFetché–¢æ•°
function _fetchHubSpot(method, url, payload = null) {
  const options = {
    method: method,
    headers: {
      Authorization: `Bearer ${HUBSPOT_TOKEN}`,
      "Content-Type": "application/json"
    },
    muteHttpExceptions: true
  };
  if (payload) options.payload = JSON.stringify(payload);

  const res = UrlFetchApp.fetch(url, options);
  const code = res.getResponseCode();
  const content = res.getContentText();

  if (code >= 400) {
    throw new Error(`HubSpot API Error (${code}): ${content}`);
  }
  return content ? JSON.parse(content) : {};
}

// ==========================================
// 6. ãƒ†ã‚¹ãƒˆãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ (TEST / DRY-RUN)
// ==========================================

/**
 * ã€å®‰å…¨ãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œç”¨ã€‘
 * HubSpotã¸ã®æ›¸ãè¾¼ã¿ã‚’è¡Œã‚ãšã€å®Ÿè¡Œã•ã‚Œã‚‹ã¯ãšã®å‡¦ç†ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¾ã™ã€‚
 * ãƒ­ã‚¸ãƒƒã‚¯ã®æ­£ã—ã•ï¼ˆæœˆæ¬¡å±•é–‹ã®è¨ˆç®—ãªã©ï¼‰ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
 */
function run_DryRun_Simulation() {
  Logger.log("ğŸš€ ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆæ“¬ä¼¼å®Ÿè¡Œï¼‰ã‚’é–‹å§‹ã—ã¾ã™...");
  Logger.log("â€» ã“ã®å‡¦ç†ã§ã¯HubSpotã¸ã®æ›¸ãè¾¼ã¿ã¯ä¸€åˆ‡è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚\n");

  const SHEET_NAME = 'sync_state';
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (!sheet) {
    Logger.log("âŒ ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  // 1. ç›´è¿‘ã®æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã“ã“ã¯æœ¬ç•ªã¨åŒã˜ï¼‰
  const updatedDeals = api_fetchRecentlyUpdatedDeals(240);
  Logger.log(`ğŸ” ç›´è¿‘24æ™‚é–“ã®æ›´æ–°å¯¾è±¡Dealæ•°: ${updatedDeals.length}ä»¶`);

  if (updatedDeals.length === 0) {
    Logger.log("å¯¾è±¡ãŒãªã„ãŸã‚çµ‚äº†ã—ã¾ã™ã€‚");
    return;
  }

  // 2. ã‚·ãƒ¼ãƒˆã®çŠ¶æ…‹ãƒãƒƒãƒ—ä½œæˆ
  const lastRow = sheet.getLastRow();
  const sheetData = lastRow > 1 ? sheet.getRange(2, 1, lastRow - 1, 10).getValues() : [];
  const stateMap = new Map();
  sheetData.forEach((row, index) => {
    stateMap.set(String(row[0]), { rowIndex: index + 2, rowData: row });
  });

  // 3. ãƒ«ãƒ¼ãƒ—å‡¦ç†ï¼ˆæ›¸ãè¾¼ã¿éƒ¨åˆ†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã«ç½®æ›ï¼‰
  updatedDeals.forEach(deal => {
    try {
      test_processSingleDeal_Safe(deal, stateMap);
    } catch (e) {
      Logger.log(`âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${e.message}`);
    }
  });

  Logger.log("\nâœ… ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³çµ‚äº†");
}

/**
 * å‡¦ç†åˆ¤å®šã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
 */
function test_processSingleDeal_Safe(deal, stateMap) {
  const dealId = deal.id;
  const props = deal.properties;
  const dealName = props.dealname;

  Logger.log(`\n--------------------------------------------------`);
  Logger.log(`ğŸ“ å–¶æ¥­Dealæ¤œè¨¼: [${dealId}] ${dealName}`);
  Logger.log(`   Stage: ${props.dealstage}`);

  // ç¾åœ¨ã®å•†å“çŠ¶æ…‹ã‚’å–å¾—
  const currentLineItemIds = api_fetchLineItemIdsForDeal(dealId);
  const currentSnapshot = {};
  
  currentLineItemIds.forEach(id => {
    const detail = api_fetchLineItemDetail(id);
    if(detail && detail.properties) {
      currentSnapshot[id] = {
        name: detail.properties.name,
        price: detail.properties.price,
        quantity: detail.properties.quantity,
        period: detail.properties.hs_recurring_billing_period,
        start: detail.properties.hs_recurring_billing_start_date
      };
    }
  });

  const currentSnapshotJson = JSON.stringify(currentSnapshot);
  const state = stateMap.get(dealId);

  // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
  if (!state) {
    Logger.log("   ğŸ‘‰ åˆ¤å®šçµæœ: ã€æ–°è¦ä½œæˆã€‘ãŒå¿…è¦ã§ã™");
    test_simulateRebuild(dealId, props, currentSnapshot);
  } else {
    const lastSnapshotJson = state.rowData[7] || "{}";
    const lastStage = state.rowData[2];
    const lastName = state.rowData[1];

    const isLineItemChanged = (currentSnapshotJson !== lastSnapshotJson);
    const isPropChanged = (lastStage !== props.dealstage || lastName !== props.dealname);

    if (isLineItemChanged) {
      Logger.log("   ğŸ‘‰ åˆ¤å®šçµæœ: ã€å•†å“å¤‰æ›´æ¤œçŸ¥ã€‘ -> å…¨å†æ§‹ç¯‰ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ");
      Logger.log(`      (æ—§): ${lastSnapshotJson}`);
      Logger.log(`      (æ–°): ${currentSnapshotJson}`);
      test_simulateRebuild(dealId, props, currentSnapshot);
    } else if (isPropChanged) {
      Logger.log("   ğŸ‘‰ åˆ¤å®šçµæœ: ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å¤‰æ›´ã€‘ -> æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ");
      Logger.log(`      å¤‰æ›´å†…å®¹: ã‚¹ãƒ†ãƒ¼ã‚¸[${lastStage}â†’${props.dealstage}] / åå‰[${lastName}â†’${props.dealname}]`);
    } else {
      Logger.log("   ğŸ‘‰ åˆ¤å®šçµæœ: ã€å¤‰æ›´ãªã—ã€‘ -> ã‚¹ã‚­ãƒƒãƒ—");
    }
  }
}

/**
 * å†æ§‹ç¯‰ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè¨ˆç®—çµæœã‚’è¡¨ç¤ºï¼‰
 */
function test_simulateRebuild(originDealId, salesProps, snapshot) {
  // 1. æ—¢å­˜æ¤œç´¢ï¼ˆå®Ÿéš›ã«ã¯å‰Šé™¤ã—ãªã„ï¼‰
  const existingDeals = api_searchExistingReportDeals(originDealId);
  if (existingDeals.length > 0) {
    Logger.log(`      ğŸ—‘ [Mock] æ—¢å­˜ã®ãƒ¬ãƒãƒ¼ãƒˆDeal ${existingDeals.length}ä»¶ ã‚’å‰Šé™¤ã—ã¾ã™`);
  } else {
    Logger.log(`      ğŸ—‘ [Mock] å‰Šé™¤å¯¾è±¡ã®æ—¢å­˜Dealã¯ã‚ã‚Šã¾ã›ã‚“`);
  }

  if (Object.keys(snapshot).length === 0) {
    Logger.log("      âš ï¸ å•†å“ãŒãªã„ãŸã‚ã€ä½œæˆå‡¦ç†ã¯è¡Œã‚ã‚Œã¾ã›ã‚“");
    return;
  }

  // 2. å±•é–‹ãƒ­ã‚¸ãƒƒã‚¯ã®æ¤œè¨¼ï¼ˆã“ã“ãŒé‡è¦ï¼ï¼‰
  // æœ¬ç•ªã¨åŒã˜ helper é–¢æ•°ã‚’ä½¿ã£ã¦è¨ˆç®—çµæœã‚’ç¢ºèªã™ã‚‹
  const monthlyData = helper_expandMonthlyData(snapshot);

  Logger.log(`      ğŸ“¦ [Mock] ä»¥ä¸‹ã®å†…å®¹ã§ãƒ¬ãƒãƒ¼ãƒˆDealã‚’ä½œæˆã—ã¾ã™:`);
  
  const reportStage = STAGE_MAP["default"][salesProps.dealstage] || "ãƒãƒƒãƒ—ãªã—(ERROR)";
  const companyName = salesProps.dealname.split("_")[0];

  Object.keys(monthlyData).sort().forEach(ym => {
    const m = monthlyData[ym];
    const [yyyy, mm] = ym.split("-");
    
    // ä½œæˆã•ã‚Œã‚‹ã¯ãšã®Dealå
    const dealName = `${companyName} ${yyyy}å¹´${mm}æœˆåˆ†`;
    
    Logger.log(`         ---------------------------`);
    Logger.log(`         ğŸ“… å¯¾è±¡æœˆ: ${ym}`);
    Logger.log(`            Dealå: ${dealName}`);
    Logger.log(`            Stage : ${reportStage}`);
    Logger.log(`            Amount: ${m.amount.toLocaleString()} å††`);
    Logger.log(`            è¨ˆä¸Šæ—¥: ${m.first_recorded_date}`);
    Logger.log(`            å•†å“æ•°: ${m.lineItems.length} å€‹`);
    
    // å•†å“ã®å†…è¨³ã‚‚è¡¨ç¤º
    m.lineItems.forEach(li => {
      Logger.log(`              - ${li.name} (Â¥${li.price} x ${li.quantity})`);
    });
  });
}

// ==========================================
// 7. åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨ (INIT ONLY)
// ==========================================

/**
 * ã€åˆå›é™å®šã€‘ç¾çŠ¶ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆé–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
 * â€» IDåˆ—ã®è‡ªå‹•å¤‰æ›ã‚’é˜²ããŸã‚ "'" ã‚’ä»˜ä¸
 */
function init_CaptureCurrentState_Only() {
  const SHEET_NAME = 'sync_state';
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (!sheet) {
    Logger.log("âŒ ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  const HOURS_BACK = 240; 
  Logger.log(`ğŸ“¥ éå» ${HOURS_BACK} æ™‚é–“ä»¥å†…ã®å–¶æ¥­Dealã‚’å–å¾—ã—ã¦è¨˜éŒ²ã—ã¾ã™...`);
  
  const activeDeals = api_fetchRecentlyUpdatedDeals(HOURS_BACK);
  if (activeDeals.length === 0) return;

  const lastRow = sheet.getLastRow();
  const existingIds = new Set();
  if (lastRow > 1) {
    const data = sheet.getRange(2, 1, lastRow - 1, 1).getValues();
    data.forEach(r => existingIds.add(String(r[0])));
  }

  let addedCount = 0;

  activeDeals.forEach(deal => {
    const dealId = deal.id;
    if (existingIds.has(String(dealId))) return; 

    const props = deal.properties;
    
    const currentLineItemIds = api_fetchLineItemIdsForDeal(dealId);
    const currentSnapshot = {};
    
    currentLineItemIds.forEach(id => {
      const detail = api_fetchLineItemDetail(id);
      if(detail && detail.properties) {
        currentSnapshot[id] = {
          name: detail.properties.name,
          price: detail.properties.price,
          quantity: detail.properties.quantity,
          period: detail.properties.hs_recurring_billing_period,
          start: detail.properties.hs_recurring_billing_start_date
        };
      }
    });

    // â˜…ä¿®æ­£: å…ˆé ­ã« ' ã‚’ä»˜ã‘ã‚‹
    const lineItemIdsStr = "'" + currentLineItemIds.join(",");

    sheet.appendRow([
      dealId, 
      props.dealname, 
      props.dealstage, 
      props.pipeline, 
      props.contract_expected_date, 
      props.contract_certainty,
      lineItemIdsStr, // â˜…ä¿®æ­£æ¸ˆã¿ã®æ–‡å­—åˆ—
      JSON.stringify(currentSnapshot),
      props.hs_lastmodifieddate, 
      new Date().toISOString(),
      props.hubspot_owner_id,
    ]);

    addedCount++;
    Logger.log(`âœ… è¨˜éŒ²å®Œäº†: [${dealId}] ${props.dealname}`);
  });

  Logger.log(`\nğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†: ${addedCount} ä»¶ã‚’ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¾ã—ãŸã€‚`);
}

// ==========================================
// 9. ãƒ‡ãƒãƒƒã‚°ç”¨ (ç‰¹å®šIDã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼)
// ==========================================

/**
 * ç‰¹å®šã®å–¶æ¥­å–å¼•IDã‚’æŒ‡å®šã—ã¦ã€APIã‹ã‚‰ã©ã®ã‚ˆã†ãªå€¤ãŒè¿”ã£ã¦ãã¦ãŠã‚Šã€
 * GASãŒã©ã†è¨ˆç®—ã—ã¦ã—ã¾ã†ã‹ã‚’ãƒ­ã‚°ã§ç¢ºèªã™ã‚‹è¨ºæ–­ç”¨é–¢æ•°
 * â€» HubSpotã¸ã®æ›¸ãè¾¼ã¿ã¯ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“
 */
function debug_AnalyzeSpecificDealLogic() {
  // â–¼ã“ã“ã«æ¤œè¨¼ã—ãŸã„ã€Œè¦ªå–å¼•(å–¶æ¥­Deal)ã®IDã€ã‚’å…¥ã‚Œã¦ãã ã•ã„
  const TARGET_DEAL_ID = "48504049306"; 

  Logger.log(`ğŸ•µï¸â€â™€ï¸ å–å¼•ID: ${TARGET_DEAL_ID} ã®è©³ç´°è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™...`);

  // 1. Line Item IDã‚’å–å¾—
  const lineItemIds = api_fetchLineItemIdsForDeal(TARGET_DEAL_ID);
  if (lineItemIds.length === 0) {
    Logger.log("âš ï¸ ã“ã®å–å¼•ã«ã¯å•†å“é …ç›®(Line Item)ãŒç´ä»˜ã„ã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }
  Logger.log(`ğŸ“¦ å•†å“é …ç›®æ•°: ${lineItemIds.length}å€‹`);

  // 2. å„å•†å“ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã¨è¨ˆç®—çµæœã‚’è¡¨ç¤º
  lineItemIds.forEach((itemId, index) => {
    Logger.log(`\n--- å•†å“ ${index + 1} (ID: ${itemId}) ---`);

    // APIã‹ã‚‰ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const detail = api_fetchLineItemDetail(itemId);
    const p = detail.properties;

    // ç”Ÿãƒ­ã‚°å‡ºåŠ›ï¼ˆHubSpotãŒä½•ã¨è¿”ã—ã¦ã„ã‚‹ã‹ï¼‰
    Logger.log(`[APIç”Ÿãƒ‡ãƒ¼ã‚¿]`);
    Logger.log(`  name (å•†å“å) : ${p.name}`);
    Logger.log(`  price (å˜ä¾¡)  : ${p.price}`);
    Logger.log(`  qty (æ•°é‡)    : ${p.quantity}`);
    Logger.log(`  discount (å€¤å¼•): ${p.discount}`); // â˜…ã“ã“ãŒé‡è¦
    Logger.log(`  amount (å°è¨ˆ) : ${p.amount}`);
    Logger.log(`  period (æœŸé–“) : ${p.hs_recurring_billing_period}`);
    Logger.log(`  start (é–‹å§‹æ—¥): ${p.hs_recurring_billing_start_date}`);

    // --- ç¾åœ¨ã®ãƒ­ã‚¸ãƒƒã‚¯ã§ã®è¨ˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ---
    Logger.log(`\n[ç¾åœ¨ã®ãƒ­ã‚¸ãƒƒã‚¯ã§ã®è¨ˆç®—çµæœ]`);
    
    const price = Number(p.price || 0);
    const qty = Number(p.quantity || 0);
    const rawDiscount = Number(p.discount || 0);
    
    // æœŸé–“è¨ˆç®—
    const periodStr = p.hs_recurring_billing_period || "P1M"; 
    const months = Number(periodStr.replace("P", "").replace("M", "")) || 1;
    Logger.log(`  -> å¥‘ç´„æœˆæ•°: ${months}ãƒ¶æœˆ`);

    // â˜…å•é¡Œã®ç®‡æ‰€ï¼ˆç¾åœ¨ã®è¨ˆç®—å¼ï¼‰
    const monthlyDiscount = rawDiscount / months; 
    Logger.log(`  -> æœˆæ¬¡å€¤å¼•ãé¡ (å€¤å¼•Ã·æœˆæ•°): ${Math.round(monthlyDiscount)} å††`);

    const mrr = (price * qty) - monthlyDiscount;
    Logger.log(`  -> ç®—å‡ºã•ã‚Œã‚‹MRR ( (å˜ä¾¡xæ•°é‡) - æœˆæ¬¡å€¤å¼• ): ${Math.round(mrr)} å††`);

    // --- ä¿®æ­£æ¡ˆã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå‰²ã‚Šç®—ã—ãªã„å ´åˆï¼‰ ---
    Logger.log(`\n[ä¿®æ­£æ¡ˆ: å‰²ã‚Šç®—ã—ãªã„å ´åˆ]`);
    const mrr_fixed = (price * qty) - rawDiscount;
    Logger.log(`  -> æœˆæ¬¡å€¤å¼•ãé¡ (å€¤å¼•ãã®ã¾ã¾): ${rawDiscount} å††`);
    Logger.log(`  -> ç®—å‡ºã•ã‚Œã‚‹MRR: ${mrr_fixed} å††`);
  });
  
  Logger.log("\nâœ… è¨ºæ–­çµ‚äº†");
}

// ==========================================
// 10. æ•´åˆæ€§è¨ºæ–­ãƒ„ãƒ¼ãƒ« (AUDIT TOOL)
// ==========================================

/**
 * ã€è¨ºæ–­å®Ÿè¡Œç”¨ã€‘
 * å–¶æ¥­ç”¨å–å¼•ã‚’åŸºæº–ã«ã€ãƒ¬ãƒãƒ¼ãƒˆç”¨å–å¼•ã¨ã®æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€
 * ã‚ºãƒ¬ãŒã‚ã‚‹ã‚‚ã®ã‚„æ¬ æã—ã¦ã„ã‚‹ã‚‚ã®ã‚’ã‚·ãƒ¼ãƒˆã€Œaudit_resultsã€ã«å‡ºåŠ›ã—ã¾ã™ã€‚
 * â€» HubSpotã¸ã®æ›¸ãè¾¼ã¿ãƒ»å¤‰æ›´ã¯ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“ï¼ˆRead Onlyï¼‰ã€‚
 */
function audit_CompareSalesAndReportDeals() {
  const AUDIT_SHEET_NAME = 'audit_results';
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(AUDIT_SHEET_NAME);

  if (!sheet) {
    sheet = ss.insertSheet(AUDIT_SHEET_NAME);
  } else {
    sheet.clear(); // æ¯å›ãƒªã‚»ãƒƒãƒˆ
  }

  Logger.log("ğŸ•µï¸â€â™€ï¸ æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™...");

  // ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
  const headers = [
    "å–¶æ¥­Deal ID", "å–¶æ¥­å–å¼•å", "ã‚¹ãƒ†ãƒ¼ã‚¸", "æ‰€æœ‰è€…ID", "å•†å“æ•°",
    "æœ¬æ¥ã‚ã‚‹ã¹ãç·é¡(ç†è«–å€¤)", "å®Ÿéš›ã®ãƒ¬ãƒãƒ¼ãƒˆç·é¡(å®Ÿæ¸¬å€¤)", "å·®é¡", 
    "ãƒ¬ãƒãƒ¼ãƒˆå–å¼•æ•°", "åˆ¤å®š", "è©³ç´°ã‚¨ãƒ©ãƒ¼å†…å®¹"
  ];
  sheet.appendRow(headers);
  sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold").setBackground("#ddd");

  // 1. å–¶æ¥­ç”¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å–å¼•ã‚’å…¨å–å¾—ï¼ˆå•†å“ãŒã‚ã‚‹ã‚‚ã®ã«çµã‚‹ãŸã‚å…¨ä»¶å–å¾—ã—ã¦ã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
  const salesDeals = fetchAllSalesDeals();
  Logger.log(`ğŸ” å–¶æ¥­å–å¼•ç·æ•°: ${salesDeals.length}ä»¶`);

  // 2. ãƒ¬ãƒãƒ¼ãƒˆç”¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å–å¼•ã‚’å…¨å–å¾—ï¼ˆæ¯”è¼ƒç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  // è¦ªIDã‚’ã‚­ãƒ¼ã«ã—ã¦ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ãŠã
  const reportDealsMap = fetchAllReportDealsGroupedByOrigin();
  Logger.log(`ğŸ” ãƒ¬ãƒãƒ¼ãƒˆå–å¼•ç·æ•°: ${Object.keys(reportDealsMap).length}ã‚°ãƒ«ãƒ¼ãƒ— (è¦ªå˜ä½)`);

  const outputRows = [];

  // 3. 1ä»¶ãšã¤æ¤œè¨¼
  salesDeals.forEach(deal => {
    const dealId = deal.id;
    const props = deal.properties;
    const dealName = props.dealname;
    const dealStage = props.dealstage;
    
    // å•†å“é …ç›®ã‚’å–å¾—
    const lineItemIds = api_fetchLineItemIdsForDeal(dealId);
    
    // å•†å“ãŒãªã„å–å¼•ã¯ä»Šå›ã®èª¿æŸ»å¯¾è±¡å¤–ã¨ã™ã‚‹ï¼ˆã‚ã‚‹ã„ã¯ã€Œå•†å“ãªã—ã€ã¨ã—ã¦å‡ºã™ã‹ï¼‰
    if (lineItemIds.length === 0) {
      // outputRows.push([dealId, dealName, dealStage, props.hubspot_owner_id, 0, 0, 0, 0, 0, "å¯¾è±¡å¤–", "å•†å“ãªã—"]);
      return; 
    }

    // --- A. æœ¬æ¥ã‚ã‚‹ã¹ãå§¿ï¼ˆç†è«–å€¤ï¼‰ã®è¨ˆç®— ---
    let expectedTotalAmount = 0;
    const lineItems = lineItemIds.map(id => api_fetchLineItemDetail(id)).filter(i => i); // è©³ç´°å–å¾—

    lineItems.forEach(item => {
      const p = item.properties;
      let price = Number(p.price || 0);
      const qty = Number(p.quantity || 0);
      const discount = Number(p.discount || 0);
      const name = p.name || "";

      // ãƒã‚¤ãƒŠã‚¹è£œæ­£ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæœ¬ç•ªã¨åŒã˜ï¼‰
      if (name.includes("ã€æ¸›é¡ã€‘") || name.includes("â–¼") || name.includes("å€¤å¼•")) {
        if (price > 0) price = price * -1;
      }

      // æœŸé–“è¨ˆç®—
      const periodStr = p.hs_recurring_billing_period || "P1M"; 
      const months = Number(periodStr.replace("P", "").replace("M", "")) || 1;

      // æœˆæ¬¡MRR = (å˜ä¾¡ * æ•°é‡) - å€¤å¼•ã
      // â€»ã“ã‚Œã‚’æœˆæ•°åˆ†ç©ã¿ä¸Šã’ãŸã‚‚ã®ãŒã€Œã“ã®å•†å“ã®ç†è«–ç·é¡ã€
      const monthlyMrr = (price * qty) - discount;
      const itemTotal = monthlyMrr * months;

      expectedTotalAmount += itemTotal;
    });

    // --- B. å®Ÿéš›ã®å§¿ï¼ˆå®Ÿæ¸¬å€¤ï¼‰ã®é›†è¨ˆ ---
    const childDeals = reportDealsMap[dealId] || [];
    let actualTotalAmount = 0;
    const errorMessages = [];

    // ãƒ¬ãƒãƒ¼ãƒˆå–å¼•ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
    const correctReportStage = STAGE_MAP["default"][dealStage]; // æœ¬æ¥ã‚ã‚‹ã¹ãã‚¹ãƒ†ãƒ¼ã‚¸

    childDeals.forEach(child => {
      actualTotalAmount += Number(child.properties.amount || 0);

      // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
      if (correctReportStage && child.properties.dealstage !== correctReportStage) {
        errorMessages.push(`ã‚¹ãƒ†ãƒ¼ã‚¸ä¸ä¸€è‡´(å­:${child.properties.dealstage})`);
      }
      // ç¢ºåº¦ãƒã‚§ãƒƒã‚¯
      if (props.contract_certainty && child.properties.contract_certainty !== props.contract_certainty) {
        errorMessages.push(`ç¢ºåº¦ä¸ä¸€è‡´`);
      }
    });

    // --- C. æ¯”è¼ƒåˆ¤å®š ---
    const diff = expectedTotalAmount - actualTotalAmount;
    let status = "OK";
    
    // è¨±å®¹èª¤å·®ï¼ˆ1å††æœªæº€ã¯ç„¡è¦–ãªã©ï¼‰
    if (Math.abs(diff) > 1) {
      status = "é‡‘é¡ä¸ä¸€è‡´";
      errorMessages.push(`é‡‘é¡ã‚ºãƒ¬: ${diff.toLocaleString()}å††`);
    } else if (childDeals.length === 0) {
      status = "ãƒ¬ãƒãƒ¼ãƒˆæœªä½œæˆ";
      errorMessages.push("ãƒ¬ãƒãƒ¼ãƒˆå–å¼•ãŒå­˜åœ¨ã—ã¾ã›ã‚“");
    }

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ•´ç†
    const uniqueErrors = [...new Set(errorMessages)];
    if (uniqueErrors.length > 0 && status === "OK") {
      status = "ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ä¸ä¸€è‡´"; // é‡‘é¡ã¯ã‚ã£ã¦ã‚‹ãŒã‚¹ãƒ†ãƒ¼ã‚¸ãªã©ãŒé•ã†
    }

    // --- D. å‡ºåŠ›å¯¾è±¡ã«è¿½åŠ  ---
    // æ­£å¸¸ãªã‚‚ã®ã‚‚å‡ºã™ã‹ã€ç•°å¸¸ãªã‚‚ã®ã ã‘å‡ºã™ã‹ã€‚ä»Šå›ã¯ã€Œå…¨ã¦ã€å‡ºã—ã¦ã‚·ãƒ¼ãƒˆã§ãƒ•ã‚£ãƒ«ã‚¿ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
    outputRows.push([
      dealId,
      dealName,
      dealStage,
      props.hubspot_owner_id,
      lineItems.length,
      expectedTotalAmount,
      actualTotalAmount,
      diff,
      childDeals.length,
      status,
      uniqueErrors.join(", ")
    ]);
  });

  // ã‚·ãƒ¼ãƒˆã¸ä¸€æ‹¬æ›¸ãè¾¼ã¿
  if (outputRows.length > 0) {
    sheet.getRange(2, 1, outputRows.length, headers.length).setValues(outputRows);
    
    // æ¡ä»¶ä»˜ãæ›¸å¼ï¼ˆã‚¨ãƒ©ãƒ¼ã‚’è¦‹ã‚„ã™ãï¼‰
    const range = sheet.getRange(2, 1, outputRows.length, headers.length);
    range.applyRowBanding(SpreadsheetApp.BandingTheme.LIGHT_GREY);
  }

  Logger.log("âœ… è¨ºæ–­å®Œäº†: ã‚·ãƒ¼ãƒˆ 'audit_results' ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
}

// ----------------------------------------------------
// ä»¥ä¸‹ã€è¨ºæ–­ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
// ----------------------------------------------------

// å–¶æ¥­å–å¼•ã‚’å…¨ä»¶å–å¾—
function fetchAllSalesDeals() {
  let allResults = [];
  let after = 0;
  let hasMore = true;
  const url = `https://api.hubapi.com/crm/v3/objects/deals/search`;

  while (hasMore) {
    const payload = {
      filterGroups: [{ filters: [{ propertyName: "pipeline", operator: "EQ", value: SALES_PIPELINE_ID }] }],
      properties: ["dealname", "dealstage", "hubspot_owner_id", "contract_certainty"],
      limit: 100,
      after: after
    };
    const res = _fetchHubSpot("POST", url, payload);
    allResults = allResults.concat(res.results || []);
    if (res.paging && res.paging.next) {
      after = res.paging.next.after;
    } else {
      hasMore = false;
    }
    Utilities.sleep(50);
  }
  return allResults;
}

// ãƒ¬ãƒãƒ¼ãƒˆå–å¼•ã‚’å…¨ä»¶å–å¾—ã—ã€è¦ªIDã”ã¨ã®Mapã«ã—ã¦è¿”ã™
function fetchAllReportDealsGroupedByOrigin() {
  let allResults = [];
  let after = 0;
  let hasMore = true;
  const url = `https://api.hubapi.com/crm/v3/objects/deals/search`;

  while (hasMore) {
    const payload = {
      filterGroups: [{ filters: [{ propertyName: "pipeline", operator: "EQ", value: REPORT_PIPELINE_ID }] }],
      properties: ["dealname", "dealstage", "amount", "contract_certainty", "origin_deal_id"], // è¦ªIDã‚’å–å¾—
      limit: 100,
      after: after
    };
    const res = _fetchHubSpot("POST", url, payload);
    allResults = allResults.concat(res.results || []);
    if (res.paging && res.paging.next) {
      after = res.paging.next.after;
    } else {
      hasMore = false;
    }
    Utilities.sleep(50);
  }

  // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–å‡¦ç†
  const map = {};
  allResults.forEach(deal => {
    const parentId = deal.properties.origin_deal_id;
    if (parentId) {
      if (!map[parentId]) map[parentId] = [];
      map[parentId].push(deal);
    }
  });
  return map;
}

// ==========================================
// 13. ä»ŠæœŸ(FY2026) å„ªå…ˆåº¦è¨ºæ–­ãƒ„ãƒ¼ãƒ« (å…¨é …ç›®å®Œå…¨ãƒã‚§ãƒƒã‚¯ç‰ˆ)
// ==========================================

function audit_CheckFY2026_Priority() {
  const AUDIT_SHEET_NAME = 'audit_fy2026_priority';
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(AUDIT_SHEET_NAME);

  if (!sheet) sheet = ss.insertSheet(AUDIT_SHEET_NAME);
  else sheet.clear();

  Logger.log("ğŸ•µï¸â€â™€ï¸ æœŸé–“ãƒ»é‡‘é¡ãƒ»ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å®Œå…¨è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™...");

  // æ±ºç®—æœŸè¨­å®š (2025/07 - 2026/06)
  const FY_START_YM = 202105;
  const FY_END_YM   = 202606;

  // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒã‚§ãƒƒã‚¯é …ç›®ã‚’è¿½åŠ ï¼‰
  const headers = [
    "å„ªå…ˆåº¦", "åˆ¤å®šã‚¢ã‚¯ã‚·ãƒ§ãƒ³", "ç¾çŠ¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹", 
    "è©³ç´°ã‚¨ãƒ©ãƒ¼å†…å®¹", // â˜…ã“ã“ã«ãªãœNGã‹ãŒå‡ºã¾ã™
    "å–¶æ¥­Deal ID", "å–¶æ¥­å–å¼•å", 
    "ç†è«–æœŸé–“", "å®Ÿéš›æœŸé–“", 
    "é‡‘é¡å·®åˆ†", "ãƒ¬ãƒãƒ¼ãƒˆæ•°"
  ];
  sheet.appendRow(headers);
  sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold").setBackground("#d9ead3");

  const salesDeals = fetchAllSalesDeals();
  const reportDealsMap = fetchAllReportDealsGroupedByOrigin();
  const outputRows = [];

  for (let i = 0; i < salesDeals.length; i++) {
    const deal = salesDeals[i];
    const dealId = deal.id;
    const dealName = deal.properties.dealname;
    const parentStage = deal.properties.dealstage;
    const parentCertainty = deal.properties.contract_certainty || "";
    const closeDateStr = deal.properties.closedate || "";

    const lineItemIds = api_fetchLineItemIdsForDeal(dealId);
    if (lineItemIds.length === 0) continue;
    const lineItems = lineItemIds.map(id => api_fetchLineItemDetail(id)).filter(i => i);

    // --- A. ç†è«–å€¤ï¼ˆæœŸé–“ãƒ»é‡‘é¡ï¼‰ã®è¨ˆç®— ---
    let expectedMonths = new Set();
    let theoreticalAmount = 0;

    lineItems.forEach(item => {
      const p = item.properties;
      let price = Number(p.price || 0);
      const qty = Number(p.quantity || 0);
      const discount = Number(p.discount || 0);
      const name = p.name || "";
      
      if (name.includes("ã€æ¸›é¡ã€‘") || name.includes("â–¼") || name.includes("å€¤å¼•")) {
        price = Math.abs(price) * -1;
      }

      let startDateStr = p.hs_recurring_billing_start_date || closeDateStr || deal.properties.createdate;
      if (!startDateStr) return;
      
      let startDate = new Date(startDateStr);
      const periodStr = p.hs_recurring_billing_period || "P1M"; 
      let months = 1;
      if (periodStr === "P1Y") months = 12;
      else if (periodStr.startsWith("P") && periodStr.endsWith("M")) {
        months = Number(periodStr.replace("P", "").replace("M", "")) || 1;
      }

      theoreticalAmount += ((price * qty) - discount) * months;

      let calcDate = new Date(startDate);
      calcDate.setDate(1); 
      for (let m = 0; m < months; m++) {
        let d = new Date(calcDate);
        d.setMonth(d.getMonth() + m); 
        let yyyymm = d.getFullYear() * 100 + (d.getMonth() + 1);
        expectedMonths.add(yyyymm);
      }
    });

    let isTargetFY = false;
    expectedMonths.forEach(ym => {
      if (ym >= FY_START_YM && ym <= FY_END_YM) isTargetFY = true;
    });
    if (!isTargetFY) continue;

    // --- B. å®Ÿæ¸¬å€¤ï¼ˆHubSpotãƒ‡ãƒ¼ã‚¿ï¼‰ã®ãƒã‚§ãƒƒã‚¯ ---
    const childDeals = reportDealsMap[dealId] || [];
    let actualAmount = 0;
    let actualMonths = new Set();
    
    // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ä¸ä¸€è‡´ãƒ•ãƒ©ã‚°
    let isStageMismatch = false;
    let isCertaintyMismatch = false;

    // æ­£è§£ã®ã‚¹ãƒ†ãƒ¼ã‚¸IDã‚’ç‰¹å®š
    const correctReportStageId = STAGE_MAP["default"][parentStage];

    childDeals.forEach(child => {
      actualAmount += Number(child.properties.amount || 0);
      
      // æœŸé–“ãƒã‚§ãƒƒã‚¯ç”¨
      const cName = child.properties.dealname || "";
      const match = cName.match(/(\d{4})[å¹´\-](\d{1,2})/);
      if (match) {
        actualMonths.add(Number(match[1]) * 100 + Number(match[2]));
      }

      // â˜…è¿½åŠ : ã‚¹ãƒ†ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
      if (correctReportStageId && child.properties.dealstage !== correctReportStageId) {
        isStageMismatch = true;
      }

      // â˜…è¿½åŠ : ç¢ºåº¦ãƒã‚§ãƒƒã‚¯ (è¦ªã«å€¤ãŒã‚ã‚‹å ´åˆã®ã¿)
      if (parentCertainty && child.properties.contract_certainty !== parentCertainty) {
        isCertaintyMismatch = true;
      }
    });

    // --- C. ç·åˆåˆ¤å®š ---
    const diffAmount = theoreticalAmount - actualAmount;
    
    // æœŸé–“ä¸€è‡´ãƒã‚§ãƒƒã‚¯
    const expArr = Array.from(expectedMonths).sort((a,b)=>a-b);
    const actArr = Array.from(actualMonths).sort((a,b)=>a-b);
    const isPeriodMatch = (expArr.length === actArr.length) && expArr.every((val, index) => val === actArr[index]);

    const expStr = expArr.length > 0 ? `${expArr[0]}~${expArr[expArr.length-1]}` : "ãªã—";
    const actStr = actArr.length > 0 ? `${actArr[0]}~${actArr[actArr.length-1]}` : "ãªã—";

    let status = "æ­£å¸¸";
    let action = "ãªã—";
    let priority = "æ¸ˆ";
    let errorDetails = [];

    // å„ªå…ˆé †ä½ã‚’ã¤ã‘ã¦ã‚¨ãƒ©ãƒ¼åˆ¤å®š
    if (childDeals.length === 0) {
      status = "æœªä½œæˆ";
      action = "æ–°è¦ä½œæˆ";
      priority = "é«˜";
      errorDetails.push("ãƒ¬ãƒãƒ¼ãƒˆå–å¼•ãªã—");
    } else {
      // 1. é‡‘é¡ãƒã‚§ãƒƒã‚¯
      if (Math.abs(diffAmount) > 1) {
        status = "è¦ä¿®æ­£";
        priority = "é«˜";
        errorDetails.push(`é‡‘é¡ã‚ºãƒ¬(${diffAmount}å††)`);
      }
      // 2. æœŸé–“ãƒã‚§ãƒƒã‚¯
      if (!isPeriodMatch) {
        status = "è¦ä¿®æ­£";
        priority = "é«˜";
        errorDetails.push("æœŸé–“ä¸ä¸€è‡´");
      }
      // 3. ã‚¹ãƒ†ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
      if (isStageMismatch) {
        status = "è¦ä¿®æ­£";
        if (priority !== "é«˜") priority = "ä¸­"; // é‡‘é¡ã‚ºãƒ¬ã‚ˆã‚Šã¯å„ªå…ˆåº¦ä½ã‚
        errorDetails.push("ã‚¹ãƒ†ãƒ¼ã‚¸ä¸ä¸€è‡´");
      }
      // 4. ç¢ºåº¦ãƒã‚§ãƒƒã‚¯
      if (isCertaintyMismatch) {
        status = "è¦ä¿®æ­£";
        if (priority !== "é«˜") priority = "ä¸­";
        errorDetails.push("ç¢ºåº¦ä¸ä¸€è‡´");
      }
    }

    if (errorDetails.length > 0 && action === "ãªã—") {
      action = "æ›´æ–°(ä¿®æ­£)";
    }

    outputRows.push([
      priority,
      action,
      status,
      errorDetails.join(", "), // è©³ç´°ãªã‚¨ãƒ©ãƒ¼ç†ç”±ã‚’è¡¨ç¤º
      dealId,
      dealName,
      expStr,
      actStr,
      diffAmount,
      childDeals.length
    ]);
  }

  if (outputRows.length > 0) {
    sheet.getRange(2, 1, outputRows.length, headers.length).setValues(outputRows);
    sheet.getDataRange().applyRowBanding(SpreadsheetApp.BandingTheme.LIGHT_GREY);
  }
  
  Logger.log("âœ… å®Œå…¨è¨ºæ–­å®Œäº†: ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
}

// ==========================================
// 14. ç‰¹å®šå–å¼•ã®æ·±æ˜ã‚Šèª¿æŸ»ãƒ„ãƒ¼ãƒ« (DEBUG - FIXED LIMIT)
// ==========================================

function debug_InvestigateSpecificDeal() {
  // â–¼â–¼â–¼ é¹¿å³¶å»ºè¨­æ ªå¼ä¼šç¤¾_202508 â–¼â–¼â–¼
  const TARGET_DEAL_ID = "48496858510"; 
  // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

  Logger.log(`ğŸ•µï¸â€â™€ï¸ Deal ID: ${TARGET_DEAL_ID} ã®è©³ç´°èª¿æŸ»ã‚’é–‹å§‹ã—ã¾ã™...`);

  // 1. å•†å“ï¼ˆLine Itemsï¼‰ã®ç©ç®—å†…è¨³ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã©ã†è¨ˆç®—ã—ã¦ã„ã‚‹ã‹ï¼‰
  Logger.log("--- ğŸ›’ å•†å“ãƒ‡ãƒ¼ã‚¿ (ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ç¢ºèª) ---");
  const lineItemIds = api_fetchLineItemIdsForDeal(TARGET_DEAL_ID);
  
  if (lineItemIds.length === 0) {
    Logger.log("âš ï¸ å•†å“ãŒç´ä»˜ã„ã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }

  const lineItems = lineItemIds.map(id => api_fetchLineItemDetail(id)).filter(i => i);
  let scriptTotal = 0;

  lineItems.forEach((item, index) => {
    const p = item.properties;
    const name = p.name;
    const price = Number(p.price || 0);
    const qty = Number(p.quantity || 0);
    const discount = Number(p.discount || 0);
    
    // æœŸé–“
    const periodStr = p.hs_recurring_billing_period || "P1M";
    let months = 1;
    if (periodStr === "P1Y") months = 12;
    else if (periodStr.startsWith("P") && periodStr.endsWith("M")) {
      months = Number(periodStr.replace("P", "").replace("M", "")) || 1;
    }
    
    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¨ˆç®—å¼
    const subTotal = ((price * qty) - discount) * months;
    scriptTotal += subTotal;

    Logger.log(`   [${index+1}] ${name}`);
    Logger.log(`       å˜ä¾¡:${price} x æ•°é‡:${qty} - å€¤å¼•:${discount}`);
    Logger.log(`       æœŸé–“ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£: ${periodStr} -> èªè­˜æœˆæ•°: ${months}ãƒ¶æœˆ`);
    Logger.log(`       ğŸ‘‰ ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¨ˆç®—é¡: ${subTotal.toLocaleString()}å††`);
  });
  Logger.log(`ğŸ’° ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ€ã†åˆè¨ˆé¡(Theoretical): ${scriptTotal.toLocaleString()}å††`);


  // 2. ãƒ¬ãƒãƒ¼ãƒˆå–å¼•ï¼ˆå®Ÿæ¸¬å€¤ï¼‰ã®å†…è¨³
  Logger.log("\n--- ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆå–å¼• (HubSpotä¸Šã®å®Ÿæ¸¬å€¤) ---");
  
  const reportDealsMap = fetchAllReportDealsGroupedByOrigin();
  const childDeals = reportDealsMap[TARGET_DEAL_ID] || [];
  let actualTotal = 0;

  childDeals.forEach((child, index) => {
    const amt = Number(child.properties.amount || 0);
    actualTotal += amt;
    Logger.log(`   [${index+1}] ${child.properties.dealname} | é‡‘é¡: ${amt.toLocaleString()}å††`);
  });
  Logger.log(`ğŸ“‰ å®Ÿéš›ã®åˆè¨ˆé¡(Actual): ${actualTotal.toLocaleString()}å††`);

  // 3. çµè«–
  Logger.log("--------------------------------------------------");
  Logger.log(`ğŸ å·®é¡: ${(scriptTotal - actualTotal).toLocaleString()}å††`);
}

// ==========================================
// 16. å€‹åˆ¥IDæŒ‡å®š ä¿®æ­£å®Ÿè¡Œãƒ„ãƒ¼ãƒ« (MANUAL FIX - FIXED VERSION)
// ==========================================

/**
 * æ‰‹å‹•ã§æŒ‡å®šã—ãŸIDã®å–å¼•ã ã‘ã‚’å¼·åˆ¶çš„ã«å†åŒæœŸï¼ˆå†æ§‹ç¯‰ï¼‰ã—ã¾ã™ã€‚
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æ›´æ–°åˆ¤å®šã‚’ç„¡è¦–ã—ã€HubSpotã®æœ€æ–°çŠ¶æ…‹ã«åŸºã¥ã„ã¦ãƒ¬ãƒãƒ¼ãƒˆå–å¼•ã‚’ä½œã‚Šç›´ã—ã¾ã™ã€‚
 */
function manual_FixSpecificDeals() {
  // â–¼â–¼â–¼ ä¿®æ­£ã—ãŸã„å–¶æ¥­å–å¼•ã®IDã‚’ã“ã“ã«å…¥åŠ›ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ â–¼â–¼â–¼
  const TARGET_IDS = [
      "52036274945",
      "51339928172",
      "48524568101",
      "48490462772",
      "48476988043",
      "48499330426",
      "48488755348"
  ];
  // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

  Logger.log(`ğŸ›  å€‹åˆ¥ä¿®æ­£ã‚’é–‹å§‹ã—ã¾ã™ã€‚å¯¾è±¡: ${TARGET_IDS.length}ä»¶`);

  TARGET_IDS.forEach(dealId => {
    if (!dealId) return;

    try {
      Logger.log(`ğŸ‘‰ ID: ${dealId} ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦å¼·åˆ¶å†æ§‹ç¯‰ã—ã¾ã™...`);
      
      // ä¸‹è¨˜ã§å®šç¾©ã—ãŸã€Œ1ä»¶å‡¦ç†ç”¨ã®å°‚ç”¨é–¢æ•°ã€ã‚’å‘¼ã³å‡ºã™
      force_Sync_OneDeal_ById(dealId);
      
      Logger.log(`âœ… ID: ${dealId} ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`);
    } catch (e) {
      Logger.log(`âŒ ID: ${dealId} ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`);
    }
    
    Utilities.sleep(1000); // APIåˆ¶é™å¯¾ç­–
  });

  Logger.log("ğŸ å…¨å¯¾è±¡ã®å‡¦ç†ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚");
}

/**
 * ã€é‡è¦ã€‘IDã²ã¨ã¤ã‚’å—ã‘å–ã‚Šã€å¿…è¦ãªæƒ…å ±ã‚’APIã§å–å¾—ã—ã¦ã‹ã‚‰
 * æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯(logic_rebuildReportDeals)ã«æ¸¡ã™ãŸã‚ã®ãƒ–ãƒªãƒƒã‚¸é–¢æ•°
 */
function force_Sync_OneDeal_ById(dealId) {
  // 1. å–¶æ¥­å–å¼•ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’APIã‹ã‚‰ç›´æ¥å–å¾—
  // â€» main_syncDeals ã§å–å¾—ã—ã¦ã„ã‚‹é …ç›®ã¨åŒã˜ã‚‚ã®ã‚’æŒ‡å®š
  const url = `https://api.hubapi.com/crm/v3/objects/deals/${dealId}?properties=dealname,dealstage,pipeline,hubspot_owner_id,contract_expected_date,contract_certainty`;
  const res = _fetchHubSpot("GET", url);
  
  if (!res || !res.id) {
    throw new Error("DealãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }

  const props = res.properties;

  // 2. å•†å“æƒ…å ±(Line Items)ã‚’å–å¾—ã—ã¦ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆ
  // â€» processSingleDeal ã®ä¸­ã«ã‚ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã¨åŒã˜æ§‹æˆã‚’ä½œã‚‹
  const currentLineItemIds = api_fetchLineItemIdsForDeal(dealId);
  const currentSnapshot = {};
  
  currentLineItemIds.forEach(id => {
    const detail = api_fetchLineItemDetail(id);
    if(detail && detail.properties) {
      currentSnapshot[id] = {
        name: detail.properties.name,
        price: detail.properties.price,
        quantity: detail.properties.quantity,
        period: detail.properties.hs_recurring_billing_period,
        start: detail.properties.hs_recurring_billing_start_date,
        discount: detail.properties.discount || "0" 
      };
    }
  });

  // 3. å†æ§‹ç¯‰ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œ
  // ã“ã‚Œã«ã‚ˆã‚Šã€æ—¢å­˜ã®ãƒ¬ãƒãƒ¼ãƒˆå–å¼•ãŒã‚ã‚Œã°å‰Šé™¤ã•ã‚Œã€æ­£ã—ã„å†…å®¹ã§æ–°è¦ä½œæˆã•ã‚Œã¾ã™
  logic_rebuildReportDeals(dealId, props, currentSnapshot);
}
